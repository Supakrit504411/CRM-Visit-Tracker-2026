<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 50px; }
        
        /* Login Styles */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 2.5rem; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); width: 85%; max-width: 380px; text-align: center;
        }

        /* App Styles */
        .hidden { display: none !important; }
        .card { border: none; shadow-sm: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border-radius: 12px; }
        .nav-pills .nav-link.active { background-color: #0d6efd; font-weight: 600; box-shadow: 0 2px 4px rgba(13,110,253,0.3); }
        .img-thumbnail-icon { width: 45px; height: 45px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid #dee2e6; margin: 2px; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        
        /* Footer Credit */
        .footer-credit {
            text-align: center; font-size: 0.75rem; color: #adb5bd; margin-top: 30px;
        }
        .footer-credit strong { color: #6c757d; }

        /* Header with Logout */
        .app-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }

        /* *** New Feature: Scrollable Table *** */
        .table-scroll-wrapper {
            max-height: 400px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .table-scroll-wrapper thead th {
            position: sticky; /* ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            top: 0;
            background-color: #e9ecef; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-2 p-md-4">

    <div id="loadingOverlay" class="hidden">
        <div class="spinner-border text-light mb-2" role="status"></div>
        <div id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <div id="loginScreen">
        <div class="login-box">
            <h2 class="mb-4 text-primary fw-bold"><i class="bi bi-shield-check"></i> CRM Login</h2>
            <input type="password" id="passwordInput" class="form-control form-control-lg mb-3 text-center" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn btn-primary w-100 py-2 fs-5" id="loginBtn" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="loginError" class="text-danger mt-3 small hidden">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        </div>
    </div>

    <div id="mainContent" class="hidden container-md" style="max-width: 800px;">
        
        <div class="app-header">
            <h4 class="fw-bold m-0 text-primary"><i class="bi bi-grid-fill"></i> CRM System</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <ul class="nav nav-pills nav-fill mb-3" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" id="tab-form" onclick="switchTab('form')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-dash" onclick="switchTab('dash')">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button></li>
        </ul>

        <div id="view-form">
            <div class="card p-3">
                <form id="visitForm" onsubmit="handleSave(event)">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold m-0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadClients(true)">
                                <i class="bi bi-arrow-clockwise"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                        <select class="form-select" id="clientName" onchange="checkNewClient(this)" required>
                            <option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                        </select>
                        <input type="text" class="form-control mt-2 hidden" id="newClientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3"><label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="visitDate" required></div>
                        <div class="col-6 mb-3"><label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" class="form-control" id="visitTime" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select class="form-select" id="stage" required>
                            <option value="‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô">üîµ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</option>
                            <option value="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢">üü° ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•">üî¥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label>
                        <input type="file" class="form-control" id="uploadFiles" multiple accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>
        </div>

        <div id="view-dash" class="hidden">
            
            <div class="card p-3 mb-3">
                <div class="d-flex justify-content-between align-items-end mb-1">
                    <h6 class="fw-bold text-muted m-0">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)</h6>
                    <span id="progressText" class="badge bg-success">0%</span>
                </div>
                <div class="progress" style="height: 15px;"><div id="visitProgress" class="progress-bar bg-success" style="width: 0%"></div></div>
                <div class="d-flex justify-content-between small text-muted mt-1">
                    <span id="visitedCount">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß: 0</span><span id="targetCount">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 0</span>
                </div>
            </div>

            <div class="card p-3 mb-3">
                <h6 class="fw-bold text-muted mb-3 text-center">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô %)</h6>
                <div style="height: 280px; position: relative;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span id="totalBadge" class="badge bg-secondary">0</span></h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadDashboard()">üîÑ</button>
                </div>
                <div class="mb-3">
                    <select class="form-select form-select-sm" id="filterStage" onchange="renderTable()">
                        <option value="All" id="opt-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (0)</option>
                        <option value="‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô" id="opt-plan">üîµ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (0)</option>
                        <option value="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢" id="opt-appt">üü° ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (0)</option>
                        <option value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß" id="opt-visit">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß (0)</option>
                        <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•" id="opt-follow">üî¥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• (0)</option>
                    </select>
                </div>
                
                <div class="table-scroll-wrapper">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="footer-credit">
                Designed & Developed by <strong>Supakrit Thawang</strong><br>
                Asst. Manager, Business Services, PEA Nakhon Phanom
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="editRowId"> <input type="hidden" id="editClientName">
                    <h6 id="displayClientName" class="fw-bold text-primary mb-3"></h6>
                    <div class="row">
                        <div class="col-6 mb-3"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="editDate"></div>
                        <div class="col-6 mb-3"><label>‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" class="form-control" id="editTime"></div>
                    </div>
                    <div class="mb-3"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select class="form-select" id="editStage"><option value="‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô">üîµ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</option><option value="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢">üü° ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</option><option value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option><option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•">üî¥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</option></select></div>
                    <div class="mb-3 bg-light p-2 rounded"><label>üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label><input type="file" class="form-control" id="editFiles" multiple></div>
                    <button class="btn btn-primary w-100" onclick="submitEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="imageModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content bg-transparent border-0 text-center"><img id="previewImage" class="img-fluid rounded shadow" style="max-height: 90vh;"></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ************************************************
        // 1. ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const API_URL = "https://script.google.com/macros/s/AKfycbx0iejZUxCluJxRVF5cYaUzn6gU-_DYl4pX-MLwRgQZPOwhVRvpjKUBGUUyGWuzpemP/exec"; 
        // ************************************************

        let rawData = [];
        let totalClients = 0;
        let statusChartInstance = null; 
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));

        window.onload = () => {
            if (localStorage.getItem("isLoggedIn")) {
                document.getElementById("loginScreen").classList.add("hidden");
                document.getElementById("mainContent").classList.remove("hidden");
                document.getElementById('visitDate').valueAsDate = new Date();
                loadClients();
            }

            document.getElementById("passwordInput").addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); 
                    login(); 
                }
            });
        };

        async function login() {
            const pwd = document.getElementById("passwordInput").value;
            setLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...");
            try {
                const res = await fetch(`${API_URL}?action=login&password=${pwd}`);
                const data = await res.json();
                if (data.valid) {
                    localStorage.setItem("isLoggedIn", "true");
                    document.getElementById("loginScreen").classList.add("hidden");
                    document.getElementById("mainContent").classList.remove("hidden");
                    document.getElementById('visitDate').valueAsDate = new Date();
                    loadClients();
                } else {
                    document.getElementById("loginError").classList.remove("hidden");
                }
            } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"); } finally { setLoading(false); }
        }

        function logout() {
            localStorage.removeItem("isLoggedIn");
            location.reload(); 
        }

        async function loadClients(showLoading = false) {
            if(showLoading) setLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...");
            
            try {
                const res = await fetch(`${API_URL}?action=getClients`);
                const data = await res.json();
                const select = document.getElementById("clientName");
                select.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
                data.clients.forEach(c => {
                    let icon = c.latestStatus.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö") ? "üü¢" : c.latestStatus.includes("‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢") ? "üü°" : "‚ö™";
                    select.innerHTML += `<option value="${c.name}">${c.name} [${icon} ${c.latestStatus}]</option>`;
                });
                select.innerHTML += `<option value="NEW_CLIENT_OPTION" style="color:blue;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...</option>`;
                
                if(showLoading) Swal.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false });
            } catch(e) {
                console.error(e);
            } finally {
                if(showLoading) setLoading(false);
            }
        }

        async function loadDashboard() {
            setLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const res = await fetch(`${API_URL}?action=getData`);
            const data = await res.json();
            rawData = data.logs;
            totalClients = data.totalClients;
            calculateStats();
            renderTable();
            setLoading(false);
        }

        async function handleSave(e) {
            e.preventDefault();
            setLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            const files = await getFiles("uploadFiles");
            const payload = {
                action: "save",
                clientName: document.getElementById("clientName").value,
                newClientName: document.getElementById("newClientName").value,
                visitDate: document.getElementById("visitDate").value,
                visitTime: document.getElementById("visitTime").value,
                stage: document.getElementById("stage").value,
                notes: document.getElementById("notes").value,
                imageFiles: files
            };
            await sendData(payload);
            e.target.reset(); document.getElementById('visitDate').valueAsDate = new Date();
            loadClients();
        }

        async function submitEdit() {
            setLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...");
            const files = await getFiles("editFiles");
            const payload = {
                action: "update",
                rowId: document.getElementById("editRowId").value,
                clientName: document.getElementById("editClientName").value,
                visitDate: document.getElementById("editDate").value,
                visitTime: document.getElementById("editTime").value,
                stage: document.getElementById("editStage").value,
                imageFiles: files
            };
            await sendData(payload);
            editModal.hide(); loadDashboard();
        }

        async function sendData(payload) {
            await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            setLoading(false); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
        }

        function switchTab(tab) {
            document.getElementById("view-form").classList.add("hidden");
            document.getElementById("view-dash").classList.add("hidden");
            document.getElementById("tab-form").classList.remove("active");
            document.getElementById("tab-dash").classList.remove("active");
            document.getElementById(`view-${tab}`).classList.remove("hidden");
            document.getElementById(`tab-${tab}`).classList.add("active");
            if (tab === 'dash') loadDashboard();
        }

        function renderTable() {
            const filter = document.getElementById("filterStage").value;
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            let display = filter === "All" ? rawData : rawData.filter(d => d.stage.includes(filter));
            document.getElementById("totalBadge").innerText = display.length;
            if(display.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
            display.forEach((item, idx) => {
                let badge = item.stage.includes("‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢") ? "bg-warning text-dark" : item.stage.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö") ? "bg-success" : item.stage.includes("‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°") ? "bg-danger" : "bg-primary";
                let imgs = "";
                if(item.imageUrl && item.imageUrl.length > 5) {
                    item.imageUrl.split(",").forEach(url => imgs += `<img src="${url}" class="img-thumbnail-icon" onclick="showImg('${url}')">`);
                }
                let tr = `<tr>
                    <td class="text-center text-muted small">${idx+1}</td>
                    <td><button class="btn btn-sm btn-outline-primary border-0" onclick="openEdit(${item.rowId}, '${item.client}', '${item.date}', '${item.time}', '${item.stage}')"><i class="bi bi-pencil-square"></i></button></td>
                    <td><div class="fw-bold small">${item.date}</div><div class="text-muted small">${item.time}</div></td>
                    <td><div class="small fw-bold">${item.client}</div><span class="badge ${badge} mb-1">${item.stage}</span><div class="d-flex flex-wrap">${imgs}</div></td>
                </tr>`;
                tbody.innerHTML += tr;
            });
        }

        function calculateStats() {
            // 1. Coverage
            let visitedUnique = new Set(rawData.filter(d => d.stage.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö")).map(d => d.client)).size;
            let coveragePercent = totalClients > 0 ? Math.round((visitedUnique/totalClients)*100) : 0;
            document.getElementById("visitProgress").style.width = coveragePercent + "%";
            document.getElementById("progressText").innerText = coveragePercent + "%";
            document.getElementById("visitedCount").innerText = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${visitedUnique}`;
            document.getElementById("targetCount").innerText = `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${totalClients} ‡∏£‡∏≤‡∏¢`;

            // 2. Count Status
            const countPlan = rawData.filter(d => d.stage.includes("‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô")).length;
            const countAppt = rawData.filter(d => d.stage.includes("‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢")).length;
            const countVisit = rawData.filter(d => d.stage.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö")).length;
            const countFollow = rawData.filter(d => d.stage.includes("‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°")).length;
            const countAll = rawData.length;

            // Update Dropdown text
            document.getElementById("opt-all").innerText = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${countAll})`;
            document.getElementById("opt-plan").innerText = `üîµ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (${countPlan})`;
            document.getElementById("opt-appt").innerText = `üü° ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (${countAppt})`;
            document.getElementById("opt-visit").innerText = `üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${countVisit})`;
            document.getElementById("opt-follow").innerText = `üî¥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• (${countFollow})`;

            // 3. Render Pie Chart with Labels
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(statusChartInstance) { statusChartInstance.destroy(); }

            statusChartInstance = new Chart(ctx, {
                type: 'pie',
                plugins: [ChartDataLabels], 
                data: {
                    labels: ['‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô', '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•'],
                    datasets: [{
                        data: [countPlan, countAppt, countVisit, countFollow],
                        backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#dc3545'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: function(value, context) {
                                if (value === 0) return ""; 
                                let total = context.chart._metasets[context.datasetIndex].total;
                                let percentage = Math.round((value / total) * 100) + '%';
                                return value + "\n(" + percentage + ")";
                            },
                            textAlign: 'center'
                        }
                    }
                }
            });
        }

        function checkNewClient(el) { const inp = document.getElementById("newClientName"); el.value === "NEW_CLIENT_OPTION" ? inp.classList.remove("hidden") : inp.classList.add("hidden"); }
        function openEdit(rowId, client, date, time, stage) {
            document.getElementById("editRowId").value = rowId; document.getElementById("editClientName").value = client;
            document.getElementById("displayClientName").innerText = client;
            document.getElementById("editDate").value = date; document.getElementById("editTime").value = time;
            document.getElementById("editStage").value = stage; document.getElementById("editFiles").value = "";
            editModal.show();
        }
        function showImg(url) { document.getElementById("previewImage").src = url; imageModal.show(); }
        function setLoading(isLoading, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") { const el = document.getElementById("loadingOverlay"); document.getElementById("loadingText").innerText = text; isLoading ? el.classList.remove("hidden") : el.classList.add("hidden"); }
        function getFiles(id) { return Promise.all([...document.getElementById(id).files].map(f => new Promise(r => { let reader = new FileReader(); reader.onload = e => r({name: f.name, mimeType: f.type, data: e.target.result.split(',')[1]}); reader.readAsDataURL(f); }))); }
    </script>
</body>
</html>